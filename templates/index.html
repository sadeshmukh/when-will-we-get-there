<!DOCTYPE html>
<html>
  <head>
    <title>Progress Tracker</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif;
        background-color: #ffffff;
        color: #000000;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 50px;
        margin: 0;
      }
      .container {
        width: 90%;
        max-width: 800px;
        text-align: center;
      }
      h1 {
        font-weight: 400;
        margin-bottom: 1rem;
        font-size: 2rem;
      }
      .prediction {
        font-size: 1.2rem;
        color: #555;
        margin-bottom: 3rem;
      }
      canvas {
        width: 100% !important;
        height: auto !important;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>When Will We Get There?!</h1>
      <div style="margin-bottom: 1rem; font-size: 0.9rem">
        <a
          href="https://are-we-there-yet.hackclub.com"
          target="_blank"
          style="color: #888"
          >are-we-there-yet.hackclub.com</a
        >
      </div>
      <div class="prediction" id="prediction-text">Calculating...</div>

      <div style="margin-bottom: 20px">
        <label>
          <input type="checkbox" id="scaleToggle" /> Scale to 100% & Predicted
          Time
        </label>
      </div>

      <canvas id="myChart"></canvas>
    </div>
    <script>
      const predictionTs = {{ prediction_ts | tojson }};
      const startTs = {{ start_ts | tojson }};
      const labels = {{ labels | tojson }};
      const values = {{ values | tojson }};

      // Format prediction text
      const predictionEl = document.getElementById('prediction-text');
      if (predictionTs) {
        const date = new Date(predictionTs * 1000);
        predictionEl.textContent = "Predicted 100% at: " + date.toLocaleString();
      } else {
        predictionEl.textContent = "Not enough data to predict.";
      }

      const ctx = document.getElementById('myChart').getContext('2d');
      const myChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: labels,
              datasets: [{
                  label: 'Percentage',
                  data: values,
                  borderColor: '#000000',
                  borderWidth: 1.5,
                  pointRadius: 0,
                  pointHoverRadius: 4,
                  fill: false,
                  tension: 0
              }]
          },
          options: {
              responsive: true,
              plugins: {
                  legend: {
                      display: false
                  },
                  tooltip: {
                      mode: 'index',
                      intersect: false,
                  }
              },
              scales: {
                  x: {
                      type: 'time',
                      time: {
                          unit: 'day',
                          displayFormats: {
                              day: 'MMM d'
                          }
                      },
                      display: true, // Changed to true to see the time scale
                      grid: {
                          display: false
                      }
                  },
                  y: {
                      beginAtZero: false,
                      grid: {
                          color: '#eeeeee'
                      }
                  }
              },
              interaction: {
                  mode: 'nearest',
                  axis: 'x',
                  intersect: false
              }
          }
      });

      // Toggle Logic
      const scaleToggle = document.getElementById('scaleToggle');
      scaleToggle.addEventListener('change', (e) => {
        if (e.target.checked) {
          // Scale to 0-100% and Start-Predicted
          myChart.options.scales.y.min = 0;
          myChart.options.scales.y.max = 100;

          if (predictionTs) {
             const predictedDate = new Date(predictionTs * 1000);
             myChart.options.scales.x.max = predictedDate.valueOf();
          }

        } else {
          // Reset
          myChart.options.scales.y.min = undefined;
          myChart.options.scales.y.max = undefined;
          myChart.options.scales.x.max = undefined;
        }
        myChart.update();
      });
    </script>
  </body>
</html>
